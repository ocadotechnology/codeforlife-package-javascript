{"version":3,"file":"server.es.js","sources":["../../src/server/server.ts"],"sourcesContent":["/**\n * Â© Ocado Group\n * Created on 13/12/2024 at 12:15:05(+00:00).\n *\n * A server for an app in a live environment.\n * Based off: https://github.com/bluwy/create-vite-extra/blob/master/template-ssr-react-ts/server.js\n */\n\nimport { Cache, type CacheClass } from \"memory-cache\"\nimport { type UUID, randomUUID } from \"node:crypto\"\nimport express, { type Express, type Request, type Response } from \"express\"\nimport fs from \"node:fs/promises\"\nimport http from \"node:http\"\n\ntype Mode = \"development\" | \"staging\" | \"production\"\ntype Options = Partial<{\n  mode: Mode\n  port: number\n  base: string\n}>\n\ntype HealthStatus =\n  | \"healthy\"\n  | \"startingUp\"\n  | \"shuttingDown\"\n  | \"unhealthy\"\n  | \"unknown\"\ntype HealthCheck = {\n  healthStatus: HealthStatus\n  additionalInfo: string\n  details?: Array<{\n    name: string\n    description: string\n    health: HealthStatus\n  }>\n}\ntype HealthCheckResponse = {\n  appId: string\n  healthStatus: HealthStatus\n  lastCheckedTimestamp: string\n  additionalInformation: string\n  startupTimestamp: string\n  appVersion: string\n  details: Array<{\n    name: string\n    description: string\n    health: HealthStatus\n  }>\n}\n\ntype Render = (path: string) => Promise<{ head?: string; html?: string }>\ntype EntryModule = { render: Render }\ntype RenderAndTemplate = [Render, string]\ntype GetRenderAndTemplate = (path: string) => Promise<RenderAndTemplate>\ntype OnServeError = (error: Error) => string | undefined\n\ntype Setup = {\n  getRenderAndTemplate: GetRenderAndTemplate\n  onServeError: OnServeError\n}\n\nexport default class Server {\n  envIsProduction: boolean\n  templateHtml: string\n  hostname: string\n  mode: Mode\n  port: number\n  base: string\n  app: Express\n  server: http.Server<typeof http.IncomingMessage, typeof http.ServerResponse>\n  cache: CacheClass<string, any>\n  healthCheckCacheKey: string\n  healthCheckCacheTimeout: number\n  healthCheckStatusCodes: Record<HealthStatus, number>\n  devtoolsWorkspaceUUID: UUID\n\n  constructor({ mode, port, base }: Options = {}) {\n    this.envIsProduction = process.env.NODE_ENV === \"production\"\n    this.templateHtml = \"\"\n    this.hostname = this.envIsProduction ? \"0.0.0.0\" : \"127.0.0.1\"\n\n    this.mode = mode || (process.env.MODE as Mode) || \"development\"\n    this.port =\n      port ||\n      (process.env.PORT\n        ? Number(process.env.PORT)\n        : this.envIsProduction\n          ? 8080\n          : 5173)\n    this.base = base || process.env.BASE || \"\"\n\n    this.app = express()\n    this.server = http.createServer(this.app)\n    this.cache = new Cache()\n\n    this.healthCheckCacheKey = \"health-check\"\n    this.healthCheckCacheTimeout = 30000\n    this.healthCheckStatusCodes = {\n      // The app is running normally.\n      healthy: 200,\n      // The app is performing app-specific initialisation which must\n      // complete before it will serve normal application requests\n      // (perhaps the app is warming a cache or something similar). You\n      // only need to use this status if your app will be in a start-up\n      // mode for a prolonged period of time.\n      startingUp: 503,\n      // The app is shutting down. As with startingUp, you only need to\n      // use this status if your app takes a prolonged amount of time\n      // to shutdown, perhaps because it waits for a long-running\n      // process to complete before shutting down.\n      shuttingDown: 503,\n      // The app is not running normally.\n      unhealthy: 503,\n      // The app is not able to report its own state.\n      unknown: 503,\n    }\n\n    this.devtoolsWorkspaceUUID = randomUUID()\n  }\n\n  // @ts-expect-error unused var\n  // eslint-disable-next-line @typescript-eslint/no-unused-vars\n  getHealthCheck(request: Request): HealthCheck {\n    return {\n      healthStatus: \"healthy\",\n      additionalInfo: \"All healthy.\",\n    }\n  }\n\n  handleHealthCheck(request: Request, response: Response): void {\n    let value: HealthCheckResponse = this.cache.get(\n      this.healthCheckCacheKey,\n    ) as HealthCheckResponse\n    if (value === null) {\n      const healthCheck = this.getHealthCheck(request)\n\n      if (healthCheck.healthStatus !== \"healthy\") {\n        console.warn(`health check: ${JSON.stringify(healthCheck)}`)\n      }\n\n      value = {\n        appId: process.env.APP_ID || \"REPLACE_ME\",\n        healthStatus: healthCheck.healthStatus,\n        lastCheckedTimestamp: new Date().toISOString(),\n        additionalInformation: healthCheck.additionalInfo,\n        startupTimestamp: new Date().toISOString(),\n        appVersion: process.env.APP_VERSION || \"REPLACE_ME\",\n        details: healthCheck.details || [],\n      }\n\n      this.cache.put(\n        this.healthCheckCacheKey,\n        value,\n        this.healthCheckCacheTimeout,\n      )\n    }\n\n    response.status(this.healthCheckStatusCodes[value.healthStatus]).json(value)\n  }\n\n  async handleServeHtml(\n    request: Request,\n    response: Response,\n    { getRenderAndTemplate, onServeError }: Setup,\n  ): Promise<void> {\n    try {\n      const path = request.originalUrl.replace(this.base, \"\")\n\n      const [render, template] = await getRenderAndTemplate(path)\n\n      const rendered = await render(path)\n\n      const html = template\n        .replace(`<!--app-head-->`, rendered.head ?? \"\")\n        .replace(`<!--app-html-->`, rendered.html ?? \"\")\n\n      response.status(200).set({ \"Content-Type\": \"text/html\" }).send(html)\n    } catch (error) {\n      if (error instanceof Error) {\n        console.error(error.stack)\n        const body = onServeError(error)\n        response.status(500).end(body)\n      }\n    }\n  }\n\n  // @ts-expect-error unused var\n  handleChromeDevTools(request: Request, response: Response) {\n    if (this.envIsProduction) {\n      response.status(404).json({})\n    } else {\n      const localWorkspacePath = process.env.LOCAL_WORKSPACE_PATH\n\n      let code: number\n      let body: object\n      if (localWorkspacePath) {\n        code = 200\n        body = {\n          workspace: {\n            uuid: this.devtoolsWorkspaceUUID,\n            root: localWorkspacePath,\n          },\n        }\n      } else {\n        code = 404\n        body = { error: \"Local workspace path not configured.\" }\n      }\n\n      response.status(code).json(body)\n    }\n  }\n\n  async setUpProduction(): Promise<Setup> {\n    const compression = (await import(\"compression\")).default\n    const sirv = (await import(\"sirv\")).default\n\n    this.templateHtml = await fs.readFile(\"./dist/client/index.html\", \"utf-8\")\n\n    this.app.use(compression())\n    this.app.use(this.base, sirv(\"./dist/client\", { extensions: [] }))\n\n    return {\n      getRenderAndTemplate: async () => {\n        const render = (\n          (await import(\n            // @ts-expect-error only present after building installing app.\n            \"../../../dist/server/entry-server.js\"\n          )) as EntryModule\n        ).render\n\n        // Use cached template.\n        const template = this.templateHtml\n\n        return [render, template]\n      },\n      onServeError: () => undefined,\n    }\n  }\n\n  async setUpDevelopment(): Promise<Setup> {\n    const { createServer } = await import(\"vite\")\n\n    const vite = await createServer({\n      configFile: \"/workspace/frontend/vite.config.ts\",\n      server: {\n        middlewareMode: true,\n        hmr: { server: this.server },\n      },\n      appType: \"custom\",\n      base: this.base,\n      mode: this.mode,\n    })\n\n    this.app.use(vite.middlewares)\n\n    return {\n      getRenderAndTemplate: async path => {\n        const render = (\n          (await vite.ssrLoadModule(\"/src/entry-server.tsx\")) as EntryModule\n        ).render\n\n        // Always read fresh template.\n        let template = await fs.readFile(\"./index.html\", \"utf-8\")\n        template = await vite.transformIndexHtml(path, template)\n\n        return [render, template]\n      },\n      onServeError: error => {\n        vite.ssrFixStacktrace(error)\n        return error.stack\n      },\n    }\n  }\n\n  async run() {\n    const setup = this.envIsProduction\n      ? await this.setUpProduction()\n      : await this.setUpDevelopment()\n\n    this.app.get(\"/health-check\", (request, response) => {\n      this.handleHealthCheck(request, response)\n    })\n\n    this.app.get(\n      \"/.well-known/appspecific/com.chrome.devtools.json\",\n      (request, response) => {\n        this.handleChromeDevTools(request, response)\n      },\n    )\n\n    this.app.get(\"*\", async (request, response) => {\n      await this.handleServeHtml(request, response, setup)\n    })\n\n    this.server.listen(this.port, this.hostname, () => {\n      let startMessage =\n        \"Server started.\\n\" +\n        `url: http://${this.hostname}:${this.port}\\n` +\n        `environment: ${process.env.NODE_ENV}\\n`\n\n      if (!this.envIsProduction) startMessage += `mode: ${this.mode}\\n`\n\n      console.log(startMessage)\n    })\n  }\n}\n"],"names":["Server","mode","port","base","express","http","Cache","randomUUID","request","response","value","healthCheck","getRenderAndTemplate","onServeError","path","render","template","rendered","html","error","body","localWorkspacePath","code","compression","sirv","fs","createServer","vite","setup","startMessage"],"mappings":";;;;;AA6DA,MAAqBA,EAAO;AAAA,EAC1B;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EAEA,YAAY,EAAE,MAAAC,GAAM,MAAAC,GAAM,MAAAC,EAAA,IAAkB,CAAA,GAAI;AAC9C,SAAK,kBAAkB,QAAQ,IAAI,aAAa,cAChD,KAAK,eAAe,IACpB,KAAK,WAAW,KAAK,kBAAkB,YAAY,aAEnD,KAAK,OAAOF,KAAS,QAAQ,IAAI,QAAiB,eAClD,KAAK,OACHC,MACC,QAAQ,IAAI,OACT,OAAO,QAAQ,IAAI,IAAI,IACvB,KAAK,kBACH,OACA,OACR,KAAK,OAAOC,KAAQ,QAAQ,IAAI,QAAQ,IAExC,KAAK,MAAMC,EAAA,GACX,KAAK,SAASC,EAAK,aAAa,KAAK,GAAG,GACxC,KAAK,QAAQ,IAAIC,EAAA,GAEjB,KAAK,sBAAsB,gBAC3B,KAAK,0BAA0B,KAC/B,KAAK,yBAAyB;AAAA;AAAA,MAE5B,SAAS;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,MAMT,YAAY;AAAA;AAAA;AAAA;AAAA;AAAA,MAKZ,cAAc;AAAA;AAAA,MAEd,WAAW;AAAA;AAAA,MAEX,SAAS;AAAA,IAAA,GAGX,KAAK,wBAAwBC,EAAA;AAAA,EAC/B;AAAA;AAAA;AAAA,EAIA,eAAeC,GAA+B;AAC5C,WAAO;AAAA,MACL,cAAc;AAAA,MACd,gBAAgB;AAAA,IAAA;AAAA,EAEpB;AAAA,EAEA,kBAAkBA,GAAkBC,GAA0B;AAC5D,QAAIC,IAA6B,KAAK,MAAM;AAAA,MAC1C,KAAK;AAAA,IAAA;AAEP,QAAIA,MAAU,MAAM;AAClB,YAAMC,IAAc,KAAK,eAAeH,CAAO;AAE/C,MAAIG,EAAY,iBAAiB,aAC/B,QAAQ,KAAK,iBAAiB,KAAK,UAAUA,CAAW,CAAC,EAAE,GAG7DD,IAAQ;AAAA,QACN,OAAO,QAAQ,IAAI,UAAU;AAAA,QAC7B,cAAcC,EAAY;AAAA,QAC1B,uBAAsB,oBAAI,KAAA,GAAO,YAAA;AAAA,QACjC,uBAAuBA,EAAY;AAAA,QACnC,mBAAkB,oBAAI,KAAA,GAAO,YAAA;AAAA,QAC7B,YAAY,QAAQ,IAAI,eAAe;AAAA,QACvC,SAASA,EAAY,WAAW,CAAA;AAAA,MAAC,GAGnC,KAAK,MAAM;AAAA,QACT,KAAK;AAAA,QACLD;AAAA,QACA,KAAK;AAAA,MAAA;AAAA,IAET;AAEA,IAAAD,EAAS,OAAO,KAAK,uBAAuBC,EAAM,YAAY,CAAC,EAAE,KAAKA,CAAK;AAAA,EAC7E;AAAA,EAEA,MAAM,gBACJF,GACAC,GACA,EAAE,sBAAAG,GAAsB,cAAAC,KACT;AACf,QAAI;AACF,YAAMC,IAAON,EAAQ,YAAY,QAAQ,KAAK,MAAM,EAAE,GAEhD,CAACO,GAAQC,CAAQ,IAAI,MAAMJ,EAAqBE,CAAI,GAEpDG,IAAW,MAAMF,EAAOD,CAAI,GAE5BI,IAAOF,EACV,QAAQ,mBAAmBC,EAAS,QAAQ,EAAE,EAC9C,QAAQ,mBAAmBA,EAAS,QAAQ,EAAE;AAEjD,MAAAR,EAAS,OAAO,GAAG,EAAE,IAAI,EAAE,gBAAgB,YAAA,CAAa,EAAE,KAAKS,CAAI;AAAA,IACrE,SAASC,GAAO;AACd,UAAIA,aAAiB,OAAO;AAC1B,gBAAQ,MAAMA,EAAM,KAAK;AACzB,cAAMC,IAAOP,EAAaM,CAAK;AAC/B,QAAAV,EAAS,OAAO,GAAG,EAAE,IAAIW,CAAI;AAAA,MAC/B;AAAA,IACF;AAAA,EACF;AAAA;AAAA,EAGA,qBAAqBZ,GAAkBC,GAAoB;AACzD,QAAI,KAAK;AACP,MAAAA,EAAS,OAAO,GAAG,EAAE,KAAK,CAAA,CAAE;AAAA,SACvB;AACL,YAAMY,IAAqB,QAAQ,IAAI;AAEvC,UAAIC,GACAF;AACJ,MAAIC,KACFC,IAAO,KACPF,IAAO;AAAA,QACL,WAAW;AAAA,UACT,MAAM,KAAK;AAAA,UACX,MAAMC;AAAA,QAAA;AAAA,MACR,MAGFC,IAAO,KACPF,IAAO,EAAE,OAAO,uCAAA,IAGlBX,EAAS,OAAOa,CAAI,EAAE,KAAKF,CAAI;AAAA,IACjC;AAAA,EACF;AAAA,EAEA,MAAM,kBAAkC;AACtC,UAAMG,KAAe,MAAM,OAAO,aAAa,GAAG,SAC5CC,KAAQ,MAAM,OAAO,MAAM,GAAG;AAEpC,gBAAK,eAAe,MAAMC,EAAG,SAAS,4BAA4B,OAAO,GAEzE,KAAK,IAAI,IAAIF,GAAa,GAC1B,KAAK,IAAI,IAAI,KAAK,MAAMC,EAAK,iBAAiB,EAAE,YAAY,CAAA,EAAC,CAAG,CAAC,GAE1D;AAAA,MACL,sBAAsB,YAAY;AAChC,cAAMT,KACH,MAAM;AAAA;AAAA,UAEL;AAAA,QAAA,GAEF,QAGIC,IAAW,KAAK;AAEtB,eAAO,CAACD,GAAQC,CAAQ;AAAA,MAC1B;AAAA,MACA,cAAc,MAAA;AAAA;AAAA,IAAM;AAAA,EAExB;AAAA,EAEA,MAAM,mBAAmC;AACvC,UAAM,EAAE,cAAAU,EAAA,IAAiB,MAAM,OAAO,MAAM,GAEtCC,IAAO,MAAMD,EAAa;AAAA,MAC9B,YAAY;AAAA,MACZ,QAAQ;AAAA,QACN,gBAAgB;AAAA,QAChB,KAAK,EAAE,QAAQ,KAAK,OAAA;AAAA,MAAO;AAAA,MAE7B,SAAS;AAAA,MACT,MAAM,KAAK;AAAA,MACX,MAAM,KAAK;AAAA,IAAA,CACZ;AAED,gBAAK,IAAI,IAAIC,EAAK,WAAW,GAEtB;AAAA,MACL,sBAAsB,OAAMb,MAAQ;AAClC,cAAMC,KACH,MAAMY,EAAK,cAAc,uBAAuB,GACjD;AAGF,YAAIX,IAAW,MAAMS,EAAG,SAAS,gBAAgB,OAAO;AACxD,eAAAT,IAAW,MAAMW,EAAK,mBAAmBb,GAAME,CAAQ,GAEhD,CAACD,GAAQC,CAAQ;AAAA,MAC1B;AAAA,MACA,cAAc,CAAAG,OACZQ,EAAK,iBAAiBR,CAAK,GACpBA,EAAM;AAAA,IACf;AAAA,EAEJ;AAAA,EAEA,MAAM,MAAM;AACV,UAAMS,IAAQ,KAAK,kBACf,MAAM,KAAK,gBAAA,IACX,MAAM,KAAK,iBAAA;AAEf,SAAK,IAAI,IAAI,iBAAiB,CAACpB,GAASC,MAAa;AACnD,WAAK,kBAAkBD,GAASC,CAAQ;AAAA,IAC1C,CAAC,GAED,KAAK,IAAI;AAAA,MACP;AAAA,MACA,CAACD,GAASC,MAAa;AACrB,aAAK,qBAAqBD,GAASC,CAAQ;AAAA,MAC7C;AAAA,IAAA,GAGF,KAAK,IAAI,IAAI,KAAK,OAAOD,GAASC,MAAa;AAC7C,YAAM,KAAK,gBAAgBD,GAASC,GAAUmB,CAAK;AAAA,IACrD,CAAC,GAED,KAAK,OAAO,OAAO,KAAK,MAAM,KAAK,UAAU,MAAM;AACjD,UAAIC,IACF;AAAA,cACe,KAAK,QAAQ,IAAI,KAAK,IAAI;AAAA,eACzB,QAAQ,IAAI,QAAQ;AAAA;AAEtC,MAAK,KAAK,oBAAiBA,KAAgB,SAAS,KAAK,IAAI;AAAA,IAE7D,QAAQ,IAAIA,CAAY;AAAA,IAC1B,CAAC;AAAA,EACH;AACF;"}
{"version":3,"file":"server.es.js","sources":["../src/server.ts"],"sourcesContent":["/**\n * Â© Ocado Group\n * Created on 13/12/2024 at 12:15:05(+00:00).\n *\n * A server for an app in a live environment.\n * Based off: https://github.com/bluwy/create-vite-extra/blob/master/template-ssr-react-ts/server.js\n */\n\nimport { Cache, type CacheClass } from \"memory-cache\"\nimport express, { type Express, type Request, type Response } from \"express\"\nimport fs from \"node:fs/promises\"\nimport http from \"node:http\"\n\ntype Mode = \"development\" | \"staging\" | \"production\"\ntype Options = Partial<{\n  mode: Mode\n  port: number\n  base: string\n}>\n\ntype HealthStatus =\n  | \"healthy\"\n  | \"startingUp\"\n  | \"shuttingDown\"\n  | \"unhealthy\"\n  | \"unknown\"\ntype HealthCheck = {\n  healthStatus: HealthStatus\n  additionalInfo: string\n  details?: Array<{\n    name: string\n    description: string\n    health: HealthStatus\n  }>\n}\ntype HealthCheckResponse = {\n  appId: string\n  healthStatus: HealthStatus\n  lastCheckedTimestamp: string\n  additionalInformation: string\n  startupTimestamp: string\n  appVersion: string\n  details: Array<{\n    name: string\n    description: string\n    health: HealthStatus\n  }>\n}\n\ntype Render = (path: string) => Promise<{ head?: string; html?: string }>\ntype EntryModule = { render: Render }\ntype RenderAndTemplate = [Render, string]\ntype GetRenderAndTemplate = (path: string) => Promise<RenderAndTemplate>\ntype OnServeError = (error: Error) => string | undefined\n\nexport default class Server {\n  envIsProduction: boolean\n  templateHtml: string\n  hostname: string\n  mode: Mode\n  port: number\n  base: string\n  app: Express\n  server: http.Server<typeof http.IncomingMessage, typeof http.ServerResponse>\n  cache: CacheClass<string, any>\n  healthCheckCacheKey: string\n  healthCheckCacheTimeout: number\n  healthCheckStatusCodes: Record<HealthStatus, number>\n\n  constructor({ mode, port, base }: Options = {}) {\n    this.envIsProduction = process.env.NODE_ENV === \"production\"\n    this.templateHtml = \"\"\n    this.hostname = this.envIsProduction ? \"0.0.0.0\" : \"127.0.0.1\"\n\n    this.mode = mode || (process.env.MODE as Mode) || \"development\"\n    this.port =\n      port ||\n      (process.env.PORT\n        ? Number(process.env.PORT)\n        : this.envIsProduction\n          ? 8080\n          : 5173)\n    this.base = base || process.env.BASE || \"/\"\n\n    this.app = express()\n    this.server = http.createServer(this.app)\n    this.cache = new Cache()\n\n    this.healthCheckCacheKey = \"health-check\"\n    this.healthCheckCacheTimeout = 30000\n    this.healthCheckStatusCodes = {\n      // The app is running normally.\n      healthy: 200,\n      // The app is performing app-specific initialisation which must\n      // complete before it will serve normal application requests\n      // (perhaps the app is warming a cache or something similar). You\n      // only need to use this status if your app will be in a start-up\n      // mode for a prolonged period of time.\n      startingUp: 503,\n      // The app is shutting down. As with startingUp, you only need to\n      // use this status if your app takes a prolonged amount of time\n      // to shutdown, perhaps because it waits for a long-running\n      // process to complete before shutting down.\n      shuttingDown: 503,\n      // The app is not running normally.\n      unhealthy: 503,\n      // The app is not able to report its own state.\n      unknown: 503,\n    }\n  }\n\n  // @ts-expect-error unused var\n  // eslint-disable-next-line @typescript-eslint/no-unused-vars\n  getHealthCheck(request: Request): HealthCheck {\n    return {\n      healthStatus: \"healthy\",\n      additionalInfo: \"All healthy.\",\n    }\n  }\n\n  handleHealthCheck(request: Request, response: Response): void {\n    let value: HealthCheckResponse = this.cache.get(\n      this.healthCheckCacheKey,\n    ) as HealthCheckResponse\n    if (value === null) {\n      const healthCheck = this.getHealthCheck(request)\n\n      if (healthCheck.healthStatus !== \"healthy\") {\n        console.warn(`health check: ${JSON.stringify(healthCheck)}`)\n      }\n\n      value = {\n        appId: process.env.APP_ID || \"REPLACE_ME\",\n        healthStatus: healthCheck.healthStatus,\n        lastCheckedTimestamp: new Date().toISOString(),\n        additionalInformation: healthCheck.additionalInfo,\n        startupTimestamp: new Date().toISOString(),\n        appVersion: process.env.APP_VERSION || \"REPLACE_ME\",\n        details: healthCheck.details || [],\n      }\n\n      this.cache.put(\n        this.healthCheckCacheKey,\n        value,\n        this.healthCheckCacheTimeout,\n      )\n    }\n\n    response.status(this.healthCheckStatusCodes[value.healthStatus]).json(value)\n  }\n\n  async handleServeHtml(\n    request: Request,\n    response: Response,\n    getRenderAndTemplate: GetRenderAndTemplate,\n    onServeError: OnServeError,\n  ): Promise<void> {\n    try {\n      const path = request.originalUrl.replace(this.base, \"\")\n\n      const [render, template] = await getRenderAndTemplate(path)\n\n      const rendered = await render(path)\n\n      const html = template\n        .replace(`<!--app-head-->`, rendered.head ?? \"\")\n        .replace(`<!--app-html-->`, rendered.html ?? \"\")\n\n      response.status(200).set({ \"Content-Type\": \"text/html\" }).send(html)\n    } catch (error) {\n      if (error instanceof Error) {\n        console.error(error.stack)\n        const body = onServeError(error)\n        response.status(500).end(body)\n      }\n    }\n  }\n\n  async run() {\n    this.app.get(\"/health-check\", (request, response) => {\n      this.handleHealthCheck(request, response)\n    })\n\n    let getRenderAndTemplate: GetRenderAndTemplate\n    let onServeError: OnServeError\n    if (this.envIsProduction) {\n      const compression = (await import(\"compression\")).default\n      const sirv = (await import(\"sirv\")).default\n\n      this.templateHtml = await fs.readFile(\"./dist/client/index.html\", \"utf-8\")\n\n      this.app.use(compression())\n      this.app.use(this.base, sirv(\"./dist/client\", { extensions: [] }))\n\n      getRenderAndTemplate = async () => {\n        const render = (\n          (await import(\n            // @ts-expect-error only present after building installing app.\n            \"../../../dist/server/entry-server.js\"\n          )) as EntryModule\n        ).render\n\n        // Use cached template.\n        const template = this.templateHtml\n\n        return [render, template]\n      }\n\n      onServeError = () => undefined\n    } else {\n      const { createServer } = await import(\"vite\")\n\n      const vite = await createServer({\n        server: { middlewareMode: true, hmr: { server: this.server } },\n        appType: \"custom\",\n        base: this.base,\n        mode: this.mode,\n      })\n\n      this.app.use(vite.middlewares)\n\n      getRenderAndTemplate = async path => {\n        const render = (\n          (await vite.ssrLoadModule(\"/src/entry-server.tsx\")) as EntryModule\n        ).render\n\n        // Always read fresh template.\n        let template = await fs.readFile(\"./index.html\", \"utf-8\")\n        template = await vite.transformIndexHtml(path, template)\n\n        return [render, template]\n      }\n\n      onServeError = error => {\n        vite.ssrFixStacktrace(error)\n        return error.stack\n      }\n    }\n\n    this.app.get(\"*\", async (request, response) => {\n      await this.handleServeHtml(\n        request,\n        response,\n        getRenderAndTemplate,\n        onServeError,\n      )\n    })\n\n    this.server.listen(this.port, this.hostname, () => {\n      let startMessage =\n        \"Server started.\\n\" +\n        `url: http://${this.hostname}:${this.port}\\n` +\n        `environment: ${process.env.NODE_ENV}\\n`\n\n      if (!this.envIsProduction) startMessage += `mode: ${this.mode}\\n`\n\n      console.log(startMessage)\n    })\n  }\n}\n"],"names":["Server","mode","port","base","express","http","Cache","request","response","value","healthCheck","getRenderAndTemplate","onServeError","path","render","template","rendered","html","error","body","compression","sirv","fs","createServer","vite","startMessage"],"mappings":"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"}